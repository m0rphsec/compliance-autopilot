name: Dogfood - Self Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 9 * * *'  # 9 AM daily

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  self-compliance:
    name: Run Compliance Autopilot on Itself
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build action
        run: |
          npm run build
          npm run package

      - name: Run Compliance Autopilot (SOC2)
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          frameworks: 'soc2'
          report-format: 'both'
          fail-on-violations: 'false'

      - name: Run Compliance Autopilot (GDPR)
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          frameworks: 'gdpr'
          report-format: 'json'
          fail-on-violations: 'false'

      - name: Run Compliance Autopilot (ISO27001)
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          frameworks: 'iso27001'
          report-format: 'json'
          fail-on-violations: 'false'

      - name: Run All Frameworks
        id: compliance
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          frameworks: 'soc2,gdpr,iso27001'
          report-format: 'both'
          fail-on-violations: 'true'

      - name: Verify outputs
        run: |
          echo "Compliance Status: ${{ steps.compliance.outputs.compliance-status }}"
          echo "Controls Passed: ${{ steps.compliance.outputs.controls-passed }}"
          echo "Controls Total: ${{ steps.compliance.outputs.controls-total }}"
          echo "Report URL: ${{ steps.compliance.outputs.report-url }}"

      - name: Upload compliance reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-reports-${{ github.run_number }}
          path: |
            compliance-report-*.pdf
            compliance-evidence-*.json
          retention-days: 90
